#!/bin/bash

list_entries() {
    entries=()

    for file in "$boot_entry_directory"/*; do
        [[ -f "$file" ]] || continue

        filename=$(basename "$file")

        title=$(grep -m1 '^title ' "$file" | cut -d ' ' -f2-)
        version=$(grep -m1 '^version ' "$file" | cut -d ' ' -f2-)
        linux=$(grep -m1 '^linux ' "$file" | cut -d ' ' -f2-)
        sortkey=$(grep -m1 '^sort-key ' "$file" | cut -d ' ' -f2-)

        # ulozime ako: filename||sortkey||output
        entries+=("$filename||$sortkey||$title ($version, $linux)\n")
    done


    while [[ $# -gt 0 ]]; do
        case "$1" in
            "-f")
                # printf - kvoli rozdeleniu riadkov
                IFS=$'\n' entries=($(printf "%s\n" "${entries[@]}" | sort -t '|' -k1))
                shift 1
                ;;
            "-s")
                IFS=$'\n' entries=($(printf "%s\n" "${entries[@]}" | sort -t '|' -k2 -k1))
                shift 1
                ;;
            "-k")
                regex=""
                shift 1

                while [[ $# -gt 0 ]]; do
                    if [[ "$1" =~ ^- ]]; then
                        break
                    fi

                    regex+="$1 "    
                    shift
                done

                # odstrani poslednu medzeru
                regex="${regex% }"  

                for i in "${!entries[@]}"; do

                    entry="${entries[$i]}"

                    linux_part="${entry##*(}"        # odstráni všetko pred poslednou zátvorkou (
                    linux_part="${linux_part%%)}"    # odstráni všetko za poslednou zátvorkou )
                    linux="${linux_part##*, }"       # vezme len časť za čiarkou (linux)

                    if [[ ! "$linux" =~ $regex ]]; then
                        unset 'entries[i]'
                    fi 
                done
                ;;
            "-t")
                regex=""
                shift 1

                while [[ $# -gt 0 ]]; do
                    if [[ "$1" =~ ^- ]]; then
                        break
                    fi

                    regex+="$1 "    
                    shift
                done

                # odstrani poslednu medzeru
                regex="${regex% }"  

                for i in "${!entries[@]}"; do

                    entry="${entries[$i]}"

                    # Odstráni prefix po treťom "||"
                    after_third="${entry#*||*||}"

                    # Odstráni zvyšok od zátvorky
                    title="${after_third%% *}"

                    if [[ ! "$title" =~ $regex ]]; then
                        unset 'entries[i]'
                    fi 
                done
                ;;
            *)
                echo "Použitie: $1 {list}"
                exit 1
                ;;
        esac
    done

    for entry in "${entries[@]}"; do
        echo "${entry##*||}"
    done
}


if [ $# -lt 1 ]; then
	echo "Niesu zadane ziadne parametre!" 1>&2
	exit 1
fi

# boot_entries_dir

boot_entry_directory="/boot/loader/entries"

if [[ "$1" == -b ]]; then
	if [[ ! -d "$2" ]]; then
		echo "cesta neexistuje" 1>&2
		exit 1
	fi
	boot_entry_directory="$2"
	shift 2
fi

# hlavne prorozdelenie

case "$1" in
    "list")
        shift 1
        list_entries $@
        ;;
    *)
        echo "Použitie: $1 {list}"
        exit 1
        ;;
esac



exit 0;